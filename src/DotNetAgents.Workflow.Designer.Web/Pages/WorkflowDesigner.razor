@page "/designer"
@page "/designer/{WorkflowId}"
@using DotNetAgents.Workflow.Designer
@using DotNetAgents.Workflow.Designer.Web.Components
@using Microsoft.AspNetCore.Components.Web
@inject IWorkflowDesignerService DesignerService
@inject NavigationManager Navigation

<PageTitle>Workflow Designer</PageTitle>

<div class="workflow-designer">
    <div class="toolbar">
        <div style="flex: 1; display: flex; align-items: center; gap: 16px;">
            <h2 style="margin: 0; font-size: 20px; font-weight: 600; color: var(--text-primary);">
                @(workflow.Name ?? "New Workflow")
            </h2>
            @if (!string.IsNullOrEmpty(workflow.Description))
            {
                <span style="color: var(--text-secondary); font-size: 14px;">@workflow.Description</span>
            }
        </div>
        <div style="display: flex; gap: 12px;">
            <button class="btn btn-primary" @onclick="SaveWorkflow" title="Save workflow">
                <span>üíæ</span> Save
            </button>
            <button class="btn btn-secondary" @onclick="ValidateWorkflow" title="Validate workflow">
                <span>‚úì</span> Validate
            </button>
            <button class="btn btn-success" @onclick="ExecuteWorkflow" title="Execute workflow">
                <span>‚ñ∂</span> Execute
            </button>
            <button class="btn btn-info" @onclick="ExportWorkflow" title="Export as JSON">
                <span>üì§</span> Export
            </button>
            <button class="btn btn-warning" @onclick="ClearCanvas" title="Clear canvas">
                <span>üóë</span> Clear
            </button>
        </div>
    </div>

    <div class="designer-container">
        <div class="node-palette">
            <h5>Node Types</h5>
            <div class="node-type" draggable="true" @ondragstart="@((e) => OnDragStart(e, "function"))">
                <span>‚öôÔ∏è</span> <span>Function</span>
            </div>
            <div class="node-type" draggable="true" @ondragstart="@((e) => OnDragStart(e, "condition"))">
                <span>‚ùì</span> <span>Condition</span>
            </div>
            <div class="node-type" draggable="true" @ondragstart="@((e) => OnDragStart(e, "parallel"))">
                <span>‚ö°</span> <span>Parallel</span>
            </div>
            <div class="node-type" draggable="true" @ondragstart="@((e) => OnDragStart(e, "human-in-loop"))">
                <span>üë§</span> <span>Human-in-Loop</span>
            </div>
            <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border);">
                <p style="font-size: 11px; color: var(--text-secondary); margin: 0; line-height: 1.6;">
                    üí° <strong>Tip:</strong> Drag nodes from the palette onto the canvas to start building your workflow.
                </p>
            </div>
        </div>

        <div class="canvas-container" @ondrop="OnDrop" @ondragover="OnDragOver" @onclick="OnCanvasClick">
            <svg class="connections-layer" width="100%" height="100%">
                @foreach (var edge in workflow.Edges)
                {
                    <line x1="@GetNodeX(edge.From)" y1="@GetNodeY(edge.From)" 
                          x2="@GetNodeX(edge.To)" y2="@GetNodeY(edge.To)"
                          class="connection-line" 
                          data-from="@edge.From" 
                          data-to="@edge.To" />
                }
            </svg>
            
            <div class="nodes-layer">
                @foreach (var node in workflow.Nodes)
                {
                    <WorkflowNodeComponent Node="@node" 
                                         OnNodeClick="@((n) => SelectNode(n))"
                                         OnNodeMove="@((n, x, y) => MoveNode(n, x, y))"
                                         IsSelected="@(selectedNode?.Id == node.Id)"
                                         ExecutionState="@(executionStates.GetValueOrDefault(node.Id))" />
                }
            </div>
        </div>

        <div class="properties-panel">
            <h5>Properties</h5>
            @if (selectedNode != null)
            {
                <NodePropertiesPanel Node="@selectedNode" OnUpdate="@UpdateNode" />
            }
            else
            {
                <p class="text-muted">Select a node to edit properties</p>
            }
        </div>
    </div>

    @if (showExecutionPanel)
    {
        <div class="execution-panel">
            <h5>Execution Status</h5>
            <div class="execution-info">
                <p><strong>Status:</strong> @executionStatus</p>
                <p><strong>Current Node:</strong> @currentExecutingNode</p>
            </div>
            <button class="btn btn-danger" @onclick="StopExecution">Stop</button>
        </div>
    }
</div>

@code {
    [Parameter] public string? WorkflowId { get; set; }

    private WorkflowDefinitionDto workflow = new();
    private WorkflowNodeDto? selectedNode;
    private string? draggedNodeType;
    private bool showExecutionPanel = false;
    private string executionStatus = "Idle";
    private string? currentExecutingNode;
    private Dictionary<string, string> executionStates = new();

    protected override async Task OnInitializedAsync()
    {
        if (!string.IsNullOrEmpty(WorkflowId))
        {
            var existing = await DesignerService.GetWorkflowAsync(WorkflowId);
            if (existing != null)
            {
                workflow = existing;
            }
        }
        else
        {
            workflow = new WorkflowDefinitionDto
            {
                Name = "New Workflow",
                Version = "1.0.0",
                Nodes = new List<WorkflowNodeDto>(),
                Edges = new List<WorkflowEdgeDto>()
            };
        }
    }

    private void OnDragStart(DragEventArgs e, string nodeType)
    {
        draggedNodeType = nodeType;
        e.DataTransfer.EffectAllowed = "copy";
    }

    private void OnDragOver(DragEventArgs e)
    {
        // Allow drop
    }

    private void OnDrop(DragEventArgs e)
    {
        // Handle drop
        
        if (string.IsNullOrEmpty(draggedNodeType))
            return;

        // Get drop position relative to canvas
        // In a real implementation, you'd calculate this from mouse coordinates
        var x = 100 + (workflow.Nodes.Count * 50);
        var y = 100 + (workflow.Nodes.Count * 50);

        var newNode = new WorkflowNodeDto
        {
            Id = Guid.NewGuid().ToString(),
            Name = $"{draggedNodeType}-{workflow.Nodes.Count + 1}",
            Type = draggedNodeType,
            X = x,
            Y = y,
            Config = new Dictionary<string, object>()
        };

        workflow.Nodes.Add(newNode);
        draggedNodeType = null;
        StateHasChanged();
    }

    private void OnCanvasClick(MouseEventArgs e)
    {
        // Deselect node when clicking on canvas
        selectedNode = null;
        StateHasChanged();
    }

    private void SelectNode(WorkflowNodeDto node)
    {
        selectedNode = node;
        StateHasChanged();
    }

    private void MoveNode(WorkflowNodeDto node, double x, double y)
    {
        node.X = (int)x;
        node.Y = (int)y;
        StateHasChanged();
    }

    private void UpdateNode(WorkflowNodeDto node)
    {
        var index = workflow.Nodes.FindIndex(n => n.Id == node.Id);
        if (index >= 0)
        {
            workflow.Nodes[index] = node;
            StateHasChanged();
        }
    }

    private double GetNodeX(string nodeId)
    {
        var node = workflow.Nodes.FirstOrDefault(n => n.Id == nodeId);
        return node?.X + 50 ?? 0; // Center of node (assuming 100px width)
    }

    private double GetNodeY(string nodeId)
    {
        var node = workflow.Nodes.FirstOrDefault(n => n.Id == nodeId);
        return node?.Y + 50 ?? 0; // Center of node (assuming 100px height)
    }

    private async Task SaveWorkflow()
    {
        try
        {
            workflow = await DesignerService.SaveWorkflowAsync(workflow);
            // Show success message
        }
        catch (Exception ex)
        {
            // Show error message
        }
    }

    private async Task ValidateWorkflow()
    {
        try
        {
            var result = await DesignerService.ValidateWorkflowAsync(workflow);
            // Show validation results
        }
        catch (Exception ex)
        {
            // Show error message
        }
    }

    private async Task ExecuteWorkflow()
    {
        showExecutionPanel = true;
        executionStatus = "Running";
        
        try
        {
            var executionId = await DesignerService.ExecuteWorkflowAsync(workflow.Name, new Dictionary<string, object>());
            // Monitor execution status
            // Update executionStates dictionary
        }
        catch (Exception ex)
        {
            executionStatus = "Error";
        }
    }

    private void StopExecution()
    {
        // Cancel execution
        executionStatus = "Stopped";
    }

    private void ExportWorkflow()
    {
        // Export workflow as JSON
        var json = System.Text.Json.JsonSerializer.Serialize(workflow, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
        // Download or copy to clipboard
    }

    private void ClearCanvas()
    {
        workflow.Nodes.Clear();
        workflow.Edges.Clear();
        selectedNode = null;
        StateHasChanged();
    }
}
